<!DOCTYPE html>
<html>
<head>
    <title>Cerrar sesión</title>
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.min.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/et-line-fonts.css">
    <link rel="stylesheet" href="css/meanmenu.css">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">

    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/dragula.min.css">
    <link rel="stylesheet" href="css/sweetalert.css">
    <link rel="stylesheet" href="css/chart.css">

    <style>
        .fade-text {
            animation: fadeInOut 1.8s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.2;
            }

            100% {
                opacity: 1;
            }
        }

    </style>

</head>
<body>

    <header>
        <admin-menu rol="manager" is-home="true"></admin-menu>  
        <script type="module" src="../Backoffice/Components/adminHeader/adminHeader.js"></script>
    </header>
     
    <div class="dashboard-area pt-30">
        <div class="container">
            <div class="row"> 
                <div class="center" style="width:100%">
                    <h2 class="text-center font-bold pt-4 pb-5 mb-5 fade-text" style="font-size:medium;">
                        <strong>Cerrando la sesión...</strong>
                    </h2>
                </div> 
            </div>
            </div>
        </div>

        <script>
            window.GlobalCssCache = {};
            async function preloadCss(path) {
                if (!window.GlobalCssCache[path]) {
                    const css = await fetch(path).then(r => r.text());
                    window.GlobalCssCache[path] = css;
                }
                return window.GlobalCssCache[path];
            }
        </script> 

        <script type="text/javascript">

            (async () => {

                await Logout();

            })()

            async function Logout() {

                await RevokeRefreshToken();
                DeleteCookies();
                DeletLocalStorage(); 
                window.location.href = 'login.html';
            }

            function DeleteCookies() {

                const COOKIE_PATH = "/Backoffice";
                const COOKIE_DOMAIN = "localhost";
                const EXPIRATION = "expires=Thu, 01 Jan 1970 00:00:00 UTC";

                const cookieNames = [
                    "app-access-token",
                    "app-refresh-token",
                    "app-role",
                    "app-profile"
                ];

                cookieNames.forEach(name => {
                    document.cookie = `${name}=; ${EXPIRATION}; path=${COOKIE_PATH}; domain=${COOKIE_DOMAIN};`;
                });

                cookieNames.forEach(name => {
                    document.cookie = `${name}=; ${EXPIRATION}; path=${COOKIE_PATH};`;
                });
            }

            function DeletLocalStorage() {

                localStorage.removeItem("idUsuario");
                localStorage.removeItem("keepSession");
                localStorage.removeItem("suscripcion");
            }

            async function RevokeRefreshToken() {
                try {
                    const baseUrl = window.location.hostname === "localhost"
                        ? "https://localhost"
                        : "https://websystem-api-prod-ctgrd4gfc2e6dudb.westeurope-01.azurewebsites.net";

                    const port = window.location.hostname === "localhost"
                        ? "44311"
                        : "";
                    const controllerName = `auth`;
                    const apiUrl = `${baseUrl}:${port}/${controllerName}`;
                    const apiMethod = `logout`;

                    const token = getCookie('app-access-token');
                    //alert(token);
                    var refreshToken = getCookie("app-refresh-token");
                    //alert(refreshToken);

                    if (refreshToken == null || token == null) return false

                    const res = await fetch(`${apiUrl}/${apiMethod}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                RefreshToken: refreshToken
                            })
                        });

                    if (!res.ok) throw new Error('Error cerrando la sesión');

                    const result = res.ok;
                    console.info("result: " + result);
                    return result;
                }
                catch (err) {
                    return false;
                }
            }

        </script> 

        <!--<script src="js/jquery.min.js"></script>-->
        <script src="js/vendor/modernizr-3.5.0.min.js"></script>
        <script src="js/vendor/jquery-1.12.4.min.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/jquery.meanmenu.min.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
</body>
</html>