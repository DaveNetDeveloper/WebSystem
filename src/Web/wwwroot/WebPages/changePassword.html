<!doctype html>
<html class="no-js" lang="es">
<head>
	<!-- Meta Tags -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="keywords" content="Cambio de contraseña">
	<meta name="description" content="Página para cambiar la contraseña.">
	<meta name='copyright' content='UOC'>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Title -->
	<title>Cambio de contraseña</title>

	<link rel="icon" href="img/favicon.png">
	<link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/nice-select.css">
	<link rel="stylesheet" href="./css/font-awesome.min.css">
	<link rel="stylesheet" href="./css/icofont.css">
	<!--<link rel="stylesheet" href="./css/slicknav.min.css">
	<link rel="stylesheet" href="./css/owl-carousel.css">
	<link rel="stylesheet" href="./css/datepicker.css">
	<link rel="stylesheet" href="./css/animate.min.css">-->

	<link rel="stylesheet" href="./css/normalize.css">
	<link rel="stylesheet" href="./css/style.css">
	<link rel="stylesheet" href="./css/responsive.css">

	<!--<link rel="stylesheet" href="./css/modalPanel.css">-->

</head>
<body>
	<div class="preloader">
		<div class="loader">
			<div class="loader-outter"></div>
			<div class="loader-inner"></div>

			<div class="indicator">
				<svg width="16px" height="12px">
					<polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
					<polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
				</svg>
			</div>
		</div>
	</div>
	<header class="header">
		<div class="header-inner">
			<div class="container">
				<div class="inner" style="padding: 18px;">
					<div class="row" style="margin-left: 48%;">
						<div>
							<div class="logo">
								<a href="home-publica.html"><img src="img/logo.jpg" alt="#"></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>
	<section class="contact-us section">
		<div class="container">
			<div class="inner">
				<div class="row">
					<div class="col-lg-12 d-flex justify-content-center">
						<div class="contact-us-form">
							<h2>Restablecer contraseña</h2>
							<p style="margin-top: 25px; font-size: 16px;">Crea tu nueva contraseña de acceso.</p>
							<div class="row" style="margin-top:25px">
								<div class="col-lg-6">
									<div class="form-group">
										<input style="width:300px" type="password" name="password" placeholder="Contraseña" value="" required>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-12">
									<div style="margin-bottom: 0; margin-top: 1rem; " class="form-group">
										<label><input disabled type="radio" name="radio1" title="Mínimo 6 carácteres." /> Mínimo 6 carácteres.</label>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-12">
									<div class="form-group">
										<label><input disabled type="radio" name="radio2" title="La contraseña debe contener 1 número." /> La contraseña debe contener 1 número.</label>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-12">
									<div class="form-group login-btn">
										<button style="width:300px" disabled class="btn" type="submit" name="btnChangePassword">GUARDAR</button>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-12">
									<div class="form-group login-btn">
										<button style="width:300px" class="btn" onclick="window.location.assign('login.html');" type="submit" name="btnInicio">IR AL INICIO DE SESIÓN</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<br /><br />
			<!--<div id="miModal" class="modal">
				<div class="modal-contenido">
					<span class="cerrar" id="cerrarModal">&times;</span>
					<h3 id="h3Modal" style="text-align: center; margin-top: 3%"></h3>
					<p id="pModal" style="margin-top: 5%"></p>
				</div>
			</div>-->
		</div>
	</section>
	<div id="footerContainer"></div>
	<script type="text/javascript">
		//cargarContenidoHtml('header.html', 'headerContainer');
		//cargarContenidoHtml('footer.html', 'footerContainer');
		//cargarContenidoHtml('modal-panel.html', 'modalPanelContainer');
		//cargarContenidoModal('Título', 'Contenido del modal...');
	</script>

    <script type="text/javascript">

        var url = new URL(window.location.href);
		var urlParams = new URLSearchParams(url.search);

		var email = urlParams.get('email');
        email = email.replace(/"/g, '');

        var emailToken = urlParams.get('emailToken');
		emailToken = emailToken.replace(/"/g, '');

        (async () => { 
            var result = await ValidarEmailToken();

            if (result) {
				enableSubmitButton(true);
                console.log("Email token validado correctamente");
                //alert("Email token validado correctamente");
            }
            else {
                //enableSubmitButton(false);
				// mostrar error de validación por pantalla
				console.log("Email token no válido");
                //alert("El enlace no es válido o ha expirado.");
            }
        })();

        function enableSubmitButton(enable) {
			const btn = document.querySelector('button[name="btnChangePassword"]');
			if (enable) {
                btn.removeAttribute('disabled');
			}
			else {
                btn.addAttribute('disabled');
			} 
		}

        async function ValidarEmailToken() {

            try {
                const baseUrl = window.location.hostname === "localhost"
                    ? "https://localhost"
                    : "https://websystem-api-prod-ctgrd4gfc2e6dudb.westeurope-01.azurewebsites.net";

                const port = window.location.hostname === "localhost"
                    ? "44311"
                    : "";
                const controllerName = `EmailTokens`;
                const apiUrl = `${baseUrl}:${port}/${controllerName}`;
                const apiMethod = `CheckEmailToken`;

                const res = await fetch(`${apiUrl}/${apiMethod}?email=${email}&emailToken=${emailToken}`,
                    {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                if (!res.ok) throw new Error('Error al recibir el resultado.');

                const data = await res;
                return data;
            }
            catch (err) {
                //alert("Error en proceso de validación del EmailToken para " + email);
                //errorMsg.textContent = err.message || 'Error durante el proceso de Validación';
            }
        }

        async function ConsumirEmailToken() {

            try {
                const baseUrl = window.location.hostname === "localhost"
                    ? "https://localhost"
                    : "https://websystem-api-prod-ctgrd4gfc2e6dudb.westeurope-01.azurewebsites.net";

                const port = window.location.hostname === "localhost"
                    ? "44311"
                    : "";
                const controllerName = `EmailTokens`;
                const apiUrl = `${baseUrl}:${port}/${controllerName}`;
                const apiMethod = `ConsumeEmailToken`;

                const ip = "0.0.0.0";
                const userAgent = navigator.userAgent;

                const res = await fetch(`${apiUrl}/${apiMethod}?&emailToken=${emailToken}&ip=${ip}&userAgent=${userAgent}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                //alert(res.ok);
                if (!res.ok) throw new Error('Error al recibir el resultado.');

                const data = await res;
                return data;
            }
			catch (err) {
				console.error("Error en proceso de invalidacion de EmailToken para " + email);
                //errorMsg.textContent = err.message || 'Error durante el proceso de Validación';
            }
		}

        function ValidarContrasena(password) {
            // Debe tener al menos 6 caracteres
            if (password.length < 6) return false;

            // Debe contener al menos un número
            const contieneNumero = /\d/.test(password);
            if (!contieneNumero) return false;

            return true;
        }

        async function ResetPassword(newPassword) {

            try {
                const baseUrl = window.location.hostname === "localhost"
                    ? "https://localhost"
                    : "https://websystem-api-prod-ctgrd4gfc2e6dudb.westeurope-01.azurewebsites.net";

                const port = window.location.hostname === "localhost"
                    ? "44311"
                    : "";
                const controllerName = `auth`;
                const apiUrl = `${baseUrl}:${port}/${controllerName}`;
                const apiMethod = `ResetPassword`;

                const res = await fetch(`${apiUrl}/${apiMethod}?email=${email}&newPassword=${newPassword}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                //alert(res.ok);
                if (!res.ok) throw new Error('Error al recibir el resultado.');

                const data = await res.json();
                return data;
            }
            catch (err) {
                console.error("Error en proceso de cambio de contraseña para la cuenta " + email);
                //errorMsg.textContent = err.message || 'Error durante el proceso de Validación';
            }
        }

        async function DeleteCookies() {

            const COOKIE_PATH = "/WebPages";
            const COOKIE_DOMAIN = "localhost";
            const EXPIRATION = "expires=Thu, 01 Jan 1970 00:00:00 UTC";

            const cookieNames = [
                "app-access-token",
                "app-refresh-token",
                "app-role",
                "app-profile"
            ];

            cookieNames.forEach(name => {
                document.cookie = `${name}=; ${EXPIRATION}; path=${COOKIE_PATH}; domain=${COOKIE_DOMAIN};`;
            });

            cookieNames.forEach(name => {
                document.cookie = `${name}=; ${EXPIRATION}; path=${COOKIE_PATH};`;
            });
        }

        function getInputValueByName(name) {
            const input = document.querySelector('input[name="' + name + '"]');
            return input.value;
		}

        async function onClickBtnChangePassword() {

            var newPassword = getInputValueByName('password');
            if (ValidarContrasena(newPassword)) {

                var resetResult = await ResetPassword(newPassword);
                console.log("ResetPassword:" + resetResult);

				if (resetResult) {
					var guid = await ConsumirEmailToken();
					await DeleteCookies();
                    console.info("Contraseña cambiada correctamente. Por favor, inicie sesión con su nueva contraseña.");
					window.location.href = '../WebPages/login.html';
				}
				else {
                    console.error("El proceso de cambio de contraseña ha fallado.");
				}
            }
            else {
                console.warn("La contraseña no es válida");
            } 
        } 
        const btnChangePassword = document.querySelector('button[name="btnChangePassword"]');
        btnChangePassword.addEventListener('click', onClickBtnChangePassword);

    </script>

	<!-- Load Scripts -->
	<!-- jquery Min JS -->
	<script src="./js/jquery.min.js"></script>
	<!-- jquery Migrate JS -->
	<script src="./js/jquery-migrate-3.0.0.js"></script>
	<!-- jquery Ui JS -->
	<script src="./js/jquery-ui.min.js"></script>
	<!-- Easing JS -->
	<script src="./js/easing.js"></script>
	<!-- Color JS -->
	<script src="./js/colors.js"></script>
	<!-- Popper JS -->
	<script src="./js/popper.min.js"></script>
	<!-- Bootstrap Datepicker JS -->
	<script src="./js/bootstrap-datepicker.js"></script>
	<!-- Jquery Nav JS -->
	<script src="./js/jquery.nav.js"></script>
	<!-- Slicknav JS -->
	<script src="./js/slicknav.min.js"></script>
	<!-- ScrollUp JS -->
	<script src="./js/jquery.scrollUp.min.js"></script>
	<!-- Niceselect JS -->
	<script src="./js/niceselect.js"></script>
	<!-- Tilt Jquery JS -->
	<script src="./js/tilt.jquery.min.js"></script>
	<!-- Owl Carousel JS -->
	<script src="./js/owl-carousel.js"></script>
	<!-- counterup JS -->
	<script src="./js/jquery.counterup.min.js"></script>
	<!-- Steller JS -->
	<script src="./js/steller.js"></script>
	<!-- Wow JS -->
	<script src="./js/wow.min.js"></script>
	<!-- Magnific Popup JS -->
	<script src="./js/jquery.magnific-popup.min.js"></script>
	<!-- Counter Up CDN JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script>
	<!-- Google Map API Key JS -->
	<script src="https://maps.google.com/maps/api/js?key=AIzaSyDGqTyqoPIvYxhn_Sa7ZrK5bENUWhpCo0w"></script>
	<!-- Gmaps JS -->
	<script src="./js/gmaps.min.js"></script>
	<!-- Map Active JS -->
	<script src="./js/map-active.js"></script>
	<!-- Bootstrap JS -->
	<script src="./js/bootstrap.min.js"></script>
	<!-- Main JS -->
	<script src="./js/main.js"></script>
</body>
</html>