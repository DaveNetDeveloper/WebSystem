<!doctype html>
<html class="no-js" lang="es">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="keywords" content="Escaneo de QR, login">
	<meta name="description" content="Página para registrar el escaneo de un código QR de un producto.">
	<meta name='copyright' content='UOC'>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>QR Login</title>

	<link rel="icon" href="img/favicon.png">

	<link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="./css/bootstrap.min.css"> 
	<link rel="stylesheet" href="./css/normalize.css">
	<link rel="stylesheet" href="./css/style.css">
	<link rel="stylesheet" href="./css/responsive.css"> 

	<script src="./js/services/qrsController.js"></script>
	<script src="./js/services/productosController.js"></script>

</head>
<body>

	<div class="preloader">
		<div class="loader">
			<div class="loader-outter"></div>
			<div class="loader-inner"></div>

			<div class="indicator">
				<svg width="16px" height="12px">
					<polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
					<polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
				</svg>
			</div>
		</div>
	</div>

	<header class="header">
		<div class="header-inner">
			<div class="container">
				<div class="inner" style="padding: 18px;">
					<div class="row" style="margin-left: 48%;">
						<div>
							<div class="logo">
								<a href="home-publica.html"><img src="img/logo.jpg" alt="#"></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>

	<section class="contact-us section">
		<div class="container">
			<div class="inner">
				<div class="row">
					
					<div class="col-lg-12">
						
						<div class="contact-us-form">
							<h4 style="text-align: center;" id="h4Subtitle">Has escaneado [productName]</h4>
							<p style="margin-top: 25px; text-align: center;" id="pSubtitle">Estás a punto de conseguir [productPoints] puntos.</p>

							<div class="row vh-100 align-items-center justify-content-center">
								<div class="col-lg-6" style="text-align: center;">
									<img name="imgProductImage" src="" alt="Imagen del producto escaneado">
								</div>
							</div>

							<app-login id="loginQRComponent" login-type="Web" is-qr-login="true"></app-login>

							<!--<label>Inicia sesión para completar el escaneo de tu producto!</label>

							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<input style="width: -webkit-fill-available;" type="email" name="emailQR" placeholder="Email" required>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<input style="width: -webkit-fill-available;" type="password" name="passwordQR" placeholder="Contraseña" required>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<a name="linkCambiarContraseña" href="" id="linkChangePassword">Has olvidado tu contraseña?</a>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-12">
									<div class="">
										<label class="checkbox-inline" for="2"><input name="news" id="2" type="checkbox">  Quieres recibir ofertas y promociones?</label>
									</div>
									<div style=" margin-top: 25px;" class="form-group login-btn">
										<button id="qrLoginButton" class="btn" type="submit" name="btnContinuar">CONTINUAR</button>
									</div>
								</div>
							</div>-->

						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	
	<script type="module" src="../Components/login/login.js"></script>

	<div id="footerContainer"></div>

    <script type="text/javascript">

        //
        class Filtros {
            constructor() {
                this.elementos = [];
            }
            agregarElemento(clave, valor) {
                this.elementos.push([clave, valor]);
            }
            obtenerValor(clave) {
                const elementoEncontrado = this.elementos.find(elemento => elemento[0] === clave);
                return elementoEncontrado ? elementoEncontrado[1] : undefined;
            }
        };

        function isExpiredDate(date) {
            const fecha = new Date(date);
            const fechaActual = new Date();
            return fecha < fechaActual;
        }

        function replaceTextByTagId(tagId, tagText, newText) {
            var element = document.getElementById(tagId);
            element.textContent = element.textContent.replace(tagText, newText);
        }

        function getCookie(nombre) {
            const nombreEQ = nombre + "=";
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1, cookie.length);
                }
                if (cookie.indexOf(nombreEQ) === 0) {
                    return decodeURIComponent(cookie.substring(nombreEQ.length, cookie.length));
                }
            }
            return null;
        }

        function setCookie(nombre, valor, expiracion) {

            // Convertir a objeto Date de JavaScript
            const date = new Date(expiracion);

            // Convertir a formato GMT para cookies
            const expires = date;// date.toUTCString();

            const cookieValor = encodeURIComponent(valor) + "; expires=" + expires; + "; path=/";

            document.cookie = nombre + "=" + cookieValor;
        }

        // cargarContenidoHtml('header.html', 'headerContainer');
        // cargarContenidoHtml('footer.html', 'footerContainer');

        var url = new URL(window.location.href);// Obtener la URL actual
        var params = new URLSearchParams(url.search);// Crear un objeto URLSearchParams
        let qrCode = params.get('qrCode');// Obtener el valor de un parámetro específico por su nombre

        // la landing QR recibe el parametro qrCode
        // si el QRCode existe, está activo y no expirado
        // obtenemos los datos del producto relacionado
        // después del login del usuario
        // consumimos el QR
        // creamos la transaccion de puntos del usuario
        // enviamos el email al usuario
        // creamos la InAppNotifivation para el usuario
        // redirecionamos a la home privada

        GetQR(qrCode)
            .then(data => {

                /*enum QrStatus
                    Inactive = 0,
                    Active = 1,
                    Consumed = 2
                */
                if (data.origen.toLowerCase() !== 'producto' || data.idProducto == null || isNaN(data.idProducto)) {

                    alert("El QR no corresponde a ningún producto.");
                    //throw new Error("El QR no corresponde a ningún producto");
                }

                // TODO - deshabilitarBoton pasando bool al componenete para que bloquee el login

                //Validaciones sobre las propiedades del QR
                if (data != null && data.status == 'Inactive') {
                    alert("El QR no está activado.");
                    deshabilitarBoton();
                }
                else if (data != null && data.status == 'Consumed') {
                    alert("El QR ya se ha consumido.");
                    deshabilitarBoton();
                }
                else if (data != null && data.status == 'Active') {
                    alert("El QR está activo.");
                }

                if (data.expiresAt !== null) {
                    //alert("El QR tiene fecha de expiración: " + data.fechaExpiracion.toString())
                    let fechaExpirada = isExpiredDate(data.expiresAt.toString());
                    if (fechaExpirada) {
                        alert("El QR está expirado");
                        deshabilitarBoton();
                    }
                }

                // llamada a productosController para obtener información del producto del QR
                // para mostrar el nombre en [productName] y los puntos en [productPoints]
                // mostrar imagen de producto según url de [data.imagen] -> "img/productos/..."

                GetProducto(data.idProducto)
                    .then(product => {

                        if (!product.activo) {
                            throw new Error("El producto asociado al QR no está activo.");
                        }

                        replaceTextByTagId('h4Subtitle', '[productName]', product.nombre);
                        replaceTextByTagId('pSubtitle', '[productPoints]', product.puntos);

                        const imagen = document.getElementsByName('imgProductImage')[0];
                        if (imagen !== null) {
                            imagen.src = product.imagen;
                            //imagen.style.maxWidth = "50%";
                            //alert("imagen: " + imagen.src);
                        }
                    })
                    .catch(error => {
                        console.error('Error en GetProducto:', error);
                        //alert('Error en PatchByFilters: ', error);
                    });
            })
            .catch(error => {
                console.error('Error en GetQR:', error);
                //alert('Error en PatchByFilters: ', error);
            });

        function deshabilitarBoton() {


            //     	var qrLoginButton = document.getElementById("qrLoginButton");
            //     	qrLoginButton.disabled = true;
            //qrLoginButton.style.cursor = "not-allowed";


        }

        //let emailQR = document.querySelector("input[name='emailQR']");
        //var linkPassword = document.getElementById('linkChangePassword');

        //linkPassword.addEventListener('click', function (event) {
        //	event.preventDefault();

        //	url = 'changePassword.html?email=' + encodeURIComponent(emailQR);
        //	window.location.href = url;
        //});

        //let passwordValue = document.querySelector("input[name='passwordQR']");

        //function onClickBtnContinuar() {

        //	 let email = document.querySelector("input[name='emailQR']");
        //	let contrasena = document.querySelector("input[name='passwordQR']");


        //	// login
        //	//

        //}

        //const btnContinuar = document.querySelector('button[name="btnContinuar"]');
        //btnContinuar.addEventListener('click', onClickBtnContinuar);

        async function consumirQr(qrId, email) {

            const baseUrl = window.location.hostname === "localhost"
                ? "https://localhost:44311"
                : "https://websystem-api-prod-ctgrd4gfc2e6dudb.westeurope-01.azurewebsites.net";
                 
            const endpoint = `${baseUrl}/api/qr/${qrId}/consume?email=${encodeURIComponent(email)}`;

            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("Error al consumir el QR:", error.message);
                    return false;
                }

                const result = await response.json(); // true
                return result;

            } catch (error) {
                console.error("Error no controlado en ConsumirQR:", error);
                return false;
            }
        }

        document.querySelector('app-login') // Escucha el evento emitido por el componente
            .addEventListener('login-success', async (e) => {

                const loginComponent = e.target;

                //const loginComponent = document.getElementById("loginQRComponent"); 
                const email = loginComponent.getEmail();

                let loverPerfilId = 'a969592b-e2ab-4b82-9ade-5c637f88f5bd';
                //var email = 'dgomezmart@uoc.edu2';


                // Usa AWAIT para esperar el resultado de la función
                const ok = await consumirQr(qrCode, email);

                if (ok) {

                    setCookie('app-profile', loverPerfilId, e.detail.expires_at);
                    //alert("QR consumido correctamente!");
                    console.info("QR consumido correctamente!");

                    // Redirección DESPUÉS de todo el proceso
                    window.location.href = '../WebPages/home-privada.html';

                } else {
                    alert("No se pudo consumir el QR.");
                }

                //// Consumir QR
                //consumirQr(qrCode, email).then(ok => {
                //    if (ok) {

                //        //alert(e.detail.expires_at);
                //        // cambiar valor del perfil del usuario Cookie('app-profile') a 'Lover'
                //        setCookie('app-profile', loverPerfilId, e.detail.expires_at);
                         
                //        alert("QR consumido correctamente!");

                //        window.location.href = '../WebPages/home-privada.html';
                //    }
                //    else {
                //        alert("No se pudo consumir el QR.");
                //    }
                //}); 

            });
             
    </script> 

	<script src="./js/jquery.min.js"></script> 
	<script src="./js/bootstrap.min.js"></script>
	<script src="./js/main.js"></script>

</body>
</html>