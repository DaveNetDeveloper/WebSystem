<!DOCTYPE html>
<html class="no-js" lang="es">
<head>
    <meta charset="utf-8" />
    <title>Activación de la cuenta</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="validación">
    <meta name="description" content="Página para la activación de la cuenta">
    <meta name='copyright' content='UOC'>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" href="img/favicon.png">

    <link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/nice-select.css">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/icofont.css">
    <link rel="stylesheet" href="./css/slicknav.min.css">
    <link rel="stylesheet" href="./css/owl-carousel.css">
    <link rel="stylesheet" href="./css/datepicker.css">
    <link rel="stylesheet" href="./css/animate.min.css">
    <link rel="stylesheet" href="./css/magnific-popup.css">

    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/responsive.css">

</head>
<body>
    <div class="preloader">
        <div class="loader">
            <div class="loader-outter"></div>
            <div class="loader-inner"></div>

            <div class="indicator">
                <svg width="16px" height="12px">
                    <polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                    <polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                </svg>
            </div>
        </div>
    </div>
    <header class="header">
        <div class="header-inner">
            <div class="container">
                <div class="inner" style="padding: 18px;">
                    <div class="row" style="margin-left: 48%;">
                        <div>
                            <div class="logo">
                                <a href="home-publica.html"><img src="img/logo.jpg" alt="#"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <section class="contact-us section" style="padding: 10% 0;">
        <div class="container">
            <div class="inner">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="contact-us-form">
                            <h5 style="text-align: center;">Un momento, estamos validando tu cuenta.</h5>
                        </div>
                    </div>
                </div>
            </div>
            <input type="text" id="errorMsg" value="" readonly style="display:none; color: red; border: 1px solid red; width: 100%; padding: 6px;">
        </div>
    </section>
    <!--<button id="btnPrueba">Probar Endpoint Seguro</button>-->
    <script type="text/javascript">

        //document.getElementById('btnPrueba').addEventListener('click', async () => {
        //    try {
        //        const usuarios = await llamarEndpointSeguro();
        //        console.log('Usuarios desde botón:', usuarios);
        //        alert('Revisa la consola para ver los usuarios'); 
        //    }
        //    catch (error) {
        //        console.error('Error al llamar al endpoint:', error);
        //        alert('Error al llamar al endpoint seguro. Revisa la consola para ver los errores');
        //    }
        //});

        //function getCookie(nombre) {
        //    const nombreEQ = nombre + "=";
        //    const cookies = document.cookie.split(';');
        //    for (let i = 0; i < cookies.length; i++) {
        //        let cookie = cookies[i];
        //        while (cookie.charAt(0) === ' ') {
        //            cookie = cookie.substring(1, cookie.length);
        //        }
        //        if (cookie.indexOf(nombreEQ) === 0) {
        //            return decodeURIComponent(cookie.substring(nombreEQ.length, cookie.length));
        //        }
        //    }
        //    return null;
        //}

        //async function llamarEndpointSeguro() {
        //    try {
        //        const token = getCookie('app-access-token');
        //        //alert(token);
        //        if (!token) throw new Error('No se encontró el token. Inicia sesión primero.');

        //        const baseUrl = `https://localhost`;
        //        const port = `44311`;
        //        const apiUrl = `${baseUrl}:${port}/Usuarios/ObtenerUsuarios`;

        //        const res = await fetch(apiUrl, {
        //            method: 'GET',
        //            headers: {
        //                'Content-Type': 'application/json',
        //                'Authorization': `Bearer ${token}`
        //            },
        //        });

        //        if (!res.ok) throw new Error('Error al llamar al endpoint seguro');

        //        return await res.json();
        //    } catch (err) {
        //        console.error(err);
        //        throw err;
        //    }
        //}

        (async () => {

            var url = new URL(window.location.href);
            var urlParams = new URLSearchParams(url.search);
            var parametro = urlParams.get('email');
            parametro = parametro.replace(/"/g, '');

            const errorMsg = this.document.getElementById('errorMsg');
            // Proceso de validación de la cuenta
            try {

                const baseUrl = `https://localhost`;
                const port = `44311`;
                const controllerName = `auth`;
                const apiUrl = `${baseUrl}:${port}/${controllerName}`;
                const apiMethod = `ValidarCuenta`;

                const res = await fetch(`${apiUrl}/${apiMethod}?email=${parametro}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                //alert(res.ok);
                if (!res.ok) throw new Error('Error al recibir el resultado.');

                const data = await res.json();
                //const tokenCodificao = btoa(token);

                //alert("access_token: " + data.access_token);
                //alert("refresh_token: " + data.refresh_token);
                //alert("expires_at: " + data.expires_at);
                //alert("role: " + data.role);

                const expiracionEnDias = 7;
                const fechaExpiracionRT = new Date();
                fechaExpiracionRT.setDate(fechaExpiracionRT.getDate() + expiracionEnDias);
                //alert("fechaExpiracionRT: " + fechaExpiracionRT);

                const expirationDate = new Date(data.expires_at);
                const gmtExpirationString = expirationDate.toUTCString();

                const cookieValor_access = encodeURIComponent(data.access_token) + "; expires=" + gmtExpirationString + "; path=/";
                document.cookie = 'app-access-token' + "=" + cookieValor_access;

                const cookieValor_refresh = encodeURIComponent(data.refresh_token) + "; expires=" + fechaExpiracionRT + "; path=/";
                document.cookie = 'app-refresh-token' + "=" + cookieValor_refresh;

                const cookieValor_role = encodeURIComponent(data.role) + "; expires=" + gmtExpirationString + "; path=/";
                document.cookie = 'app-role' + "=" + cookieValor_role;

                window.location.href = 'home-privada.html';
            }
            catch (err) {
                alert("Error en proceso de validación de la cuenta " + parametro);
                errorMsg.textContent = err.message || 'Error durante el proceso de Validación';
            }
        })();
    </script>
    
    <!-- Load Scripts -->
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery-migrate-3.0.0.js"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <script src="./js/easing.js"></script>
    <script src="./js/colors.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/bootstrap-datepicker.js"></script>
    <script src="./js/jquery.nav.js"></script>
    <script src="./js/slicknav.min.js"></script>
    <script src="./js/jquery.scrollUp.min.js"></script>
    <script src="./js/niceselect.js"></script>
    <script src="./js/tilt.jquery.min.js"></script>
    <script src="./js/owl-carousel.js"></script>
    <script src="./js/jquery.counterup.min.js"></script>
    <script src="./js/steller.js"></script>
    <script src="./js/wow.min.js"></script>
    <script src="./js/jquery.magnific-popup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script>
    <script src="https://maps.google.com/maps/api/js?key=AIzaSyDGqTyqoPIvYxhn_Sa7ZrK5bENUWhpCo0w"></script>
    <script src="./js/gmaps.min.js"></script>
    <script src="./js/map-active.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/main.js"></script>
</body>
</html>