<!doctype html>
<html class="no-js" lang="zxx">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="keywords" content="Site keywords here">
	<meta name="description" content="">
	<meta name='copyright' content=''>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Detalles de la Actividad</title>

	<link rel="icon" href="img/favicon.png">

	<link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/nice-select.css">
	<link rel="stylesheet" href="./css/font-awesome.min.css">
	<link rel="stylesheet" href="./css/icofont.css">
	<link rel="stylesheet" href="./css/slicknav.min.css">
	<link rel="stylesheet" href="./css/owl-carousel.css">
	<link rel="stylesheet" href="./css/datepicker.css">
	<link rel="stylesheet" href="./css/animate.min.css">
	<link rel="stylesheet" href="./css/magnific-popup.css">

	<link rel="stylesheet" href="./css/normalize.css">
	<link rel="stylesheet" href="./css/style.css">
	<link rel="stylesheet" href="./css/responsive.css">

	<script src="./js/services/entidadesController.js"></script>
	<script type="module" src="../Components/modalPanel/modalPanel.js"></script>
	<script src="./js/libraries/header.js"></script>
	<script src="./js/libraries/footer.js"></script>

	<style>
		p {
			color: black;
		}
	</style>

</head>
<body>

	<div class="preloader">
		<div class="loader">
			<div class="loader-outter"></div>
			<div class="loader-inner"></div>

			<div class="indicator">
				<svg width="16px" height="12px">
					<polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
					<polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
				</svg>
			</div>
		</div>
	</div>

	<header id="headerExplorarActividad" class="header"> </header>
	<script>
		(async () => {

			await renderHeader('explorar', 'headerExplorarActividad');
			await setUserData();
		})()
	</script>

	<div class="container">
		<div class="row ">
			<div class="col-lg-6  col-12">
				<modal-panel id="modalPanel-ConfirmarReserva"></modal-panel>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row ">
			<div class="col-lg-6  col-12">
				<modal-panel id="modalPanel-CancelarReserva"></modal-panel>
			</div>
		</div>
	</div>

	<div class="breadcrumbs overlay">
		<div class="container">
			<div class="bread-inner">
				<div class="row">
					<div class="col-12">
						<h2 id="nombreActividad">Detalles de la Actividad</h2>
					</div>
				</div>
			</div>
		</div>
	</div>

	<section class="news-single section">
		<div class="container">
			<div class="row">
				<div class="col-lg-8 col-12">
					<div class="row">
						<div class="col-12">
							<div class="single-main">
								<div class="news-head">
									<img id="imagenActividad" src="img/nodisponible.png" alt="#">
								</div>
								<h1 class="news-title" style="margin: 40px 0;"><a id="tipoActividad" href="news-single.html">Disfruta la mejor [tipoActividad]!</a></h1>
								<div class="meta" style="padding: 25px 0;">
									<div class="meta-left" style="margin-top: 5px;">
										<span class="author"><a id="nombreEntidad" style="font-weight:bold" href="#"><img src="" alt="#">Nombre Entidad</a></span>
										<span style="font-weight:bold" id="fechaActividad"><i class="fa fa-clock-o"></i></span>
									</div>
									<div class="meta-right" style="margin-top: 5px;">

										<!--<span class="comments"><a href="#"><i class="fa fa-comments"></i>05 Comentarios</a></span>-->
										<span id="popularidad" class="views"><i class="fa fa-eye"></i> </span>

									</div>
								</div>
								<div class="news-text">
									<p id="descripcion" style="margin-top: 20px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse facilisis ultricies tortor, nec sollicitudin lorem sagittis vitae. Curabitur rhoncus commodo rutrum. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aliquam nec lacus pulvinar, laoreet dolor quis, pellentesque ante. Cras nulla orci, pharetra at dictum consequat, pretium pretium nulla. Suspendisse porttitor nunc a sodales tempor. Mauris sed felis maximus, interdum metus vel, tincidunt diam.</p>

									<div class="image-gallery">
										<div class="row">
											<div class="col-lg-6 col-md-6 col-12">
												<div class="single-image">
													<img id="img1" src="img/nodisponible.png" alt="#">
												</div>
											</div>
											<div class="col-lg-6 col-md-6 col-12">
												<div class="single-image">
													<img id="img2" src="img/nodisponible.png" alt="#">
												</div>
											</div>
										</div>
									</div>
									<p id="descripcionCorta" style="margin-top: 25px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse facilisis ultricies tortor, nec sollicitudin lorem sagittis vitae. Curabitur rhoncus commodo rutrum. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.</p>
									<blockquote style="background-color:lightgrey;">
										<p style="color:black;" id="ubicacion"></p>
									</blockquote>

								</div>
								<!--<div class="blog-bottom">
									<ul class="social-share">
										<li class="facebook"><a href="#"><i class="fa fa-facebook"></i><span>Facebook</span></a></li>
										<li class="twitter"><a href="#"><i class="fa fa-twitter"></i><span>Twitter</span></a></li>
										<li class="google-plus"><a href="#"><i class="fa fa-google-plus"></i></a></li>
										<li class="linkedin"><a href="#"><i class="fa fa-linkedin"></i></a></li>
										<li class="pinterest"><a href="#"><i class="fa fa-pinterest"></i></a></li>
									</ul>
									<ul class="prev-next">
										<li class="prev"><a href="#"><i class="fa fa-angle-double-left"></i></a></li>
										<li class="next"><a href="#"><i class="fa fa-angle-double-right"></i></a></li>
									</ul>
								</div> -->
							</div>
						</div>
					</div>
				</div>

				<div class="col-lg-4 col-12">
					<div class="main-sidebar">

						<div style="text-align: center;" class="single-widget category">
							<a id="btnReservarActividad" style=" color: white; min-width: 225px; font-size: 18px; cursor: pointer;" class="btn">RESERVAR ACTIVIDAD</a>
							<a id="btnCancelarReserva" style="background-color: firebrick; color: white; min-width: 225px; font-size: 18px; cursor: pointer; " class="btn">CANCELAR RESERVA</a>
						</div>

						<div class="single-widget side-tags">
							<h3 class="title">Etiquetas</h3>
							<ul class="tag">
								<li><a href="#">Actividad en grupo</a></li>
								<li><a href="#">Taller</a></li>
								<li><a href="#">Creatividad</a></li>
								<li><a href="#">Terapia</a></li>
							</ul>
						</div>

						<div class="single-widget recent-post">
							<h3 class="title">Reviews</h3>
							<!-- Single Post -->
							<div class="single-post">
								<div class="image">
									<img src="img/blog-sidebar1.jpg" alt="#">
								</div>
								<div class="content">
									<h5><a href="#">We have annnocuced our new product.</a></h5>
									<ul class="comment">
										<li><i class="fa fa-calendar" aria-hidden="true"></i>Jan 11, 2020</li>
										<li><i class="fa fa-commenting-o" aria-hidden="true"></i>35</li>
									</ul>
								</div>
							</div>
							<div class="single-post">
								<div class="image">
									<img src="img/blog-sidebar2.jpg" alt="#">
								</div>
								<div class="content">
									<h5><a href="#">Top five way for solving teeth problems.</a></h5>
									<ul class="comment">
										<li><i class="fa fa-calendar" aria-hidden="true"></i>Mar 05, 2019</li>
										<li><i class="fa fa-commenting-o" aria-hidden="true"></i>59</li>
									</ul>
								</div>
							</div>
							<div class="single-post">
								<div class="image">
									<img src="img/blog-sidebar3.jpg" alt="#">
								</div>
								<div class="content">
									<h5><a href="#">We provide highly business soliutions.</a></h5>
									<ul class="comment">
										<li><i class="fa fa-calendar" aria-hidden="true"></i>June 09, 2019</li>
										<li><i class="fa fa-commenting-o" aria-hidden="true"></i>44</li>
									</ul>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
	</section>

	<script>

		(async () => {

			var url = new URL(window.location.href);
			var urlParams = new URLSearchParams(url.search);
			let idActividad = urlParams.get('id');

			let idUsuario = localStorage.getItem('idUsuario');

			const btnReservar = document.getElementById("btnReservarActividad");
			const btnCancelar = document.getElementById("btnCancelarReserva");

			btnReservar.style.display = "none";
			btnCancelar.style.display = "none";

			const reservas = await getActividadReservas(idUsuario, idActividad);

			if (reservas != null && reservas.length > 0) {
				btnCancelar.style.display = "inline-block";
				btnReservar.style.display = "none";
			} else {
				btnReservar.style.display = "inline-block";
				btnCancelar.style.display = "none";
			}
			cargarActividad(idActividad);
		})();

	async function getActividadReservas(idUsuario, idActividad) {

		const baseUrl = `https://localhost`;
		const port = `44311`;

		const url = `${baseUrl}:${port}/ActividadReservas/FiltrarActividadReservas?filters.IdUsuario=${idUsuario}&filters.IdActividad=${idActividad}&filters.Estado=Reservada`;

		const response = await fetch(url, {
			method: "GET"
		});

		if (!response.ok) {
			throw new Error(`Error ${response.status}`);
		}
		return response.json();
	}

	//
	async function cargarActividad(id) {

		const baseUrl = `https://localhost`;
		const controllerName = `Actividades`;
		const port = `44311`;
		const apiUrl = `${baseUrl}:${port}/${controllerName}/FiltrarActividades`;

		const url = `${apiUrl}?filters.Id=${id}&filters.Activo=true`;

		await fetch(url, { method: "GET" })
			.then(response => {
				if (!response.ok) throw new Error("Error en FiltrarActividades");
				return response.json();
			})
			.then(data => {

				var lista = data.items;
				if (lista != null && lista.length > 0 && lista[0] != null) {

					var actividad = lista[0];

					cargarEntidad(actividad.idEntidad);
					cargarTipoEntidad(actividad.idTipoActividad);

					document.getElementById('nombreActividad').innerText = actividad.nombre;
					document.getElementById('descripcion').innerText = actividad.descripcion;
					document.getElementById('ubicacion').innerText = '¿Dónde? En ' + actividad.ubicacion;
					document.getElementById('descripcionCorta').innerText = actividad.descripcionCorta;

					document.getElementById('popularidad').innerText = 'Popularidad: ' + actividad.popularidad;

					document.getElementById('imagenActividad').src = actividad.imagen;

					document.getElementById('img1').src = actividad.imagen;
					//document.getElementById('img2').src = actividad.imagen;

					document.getElementById('fechaActividad').innerText = formatearTimestamp(actividad.fechaInicio);

					document.getElementById('img1').innerText = actividad.imagen;
					document.getElementById('img2').innerText = actividad.imagen;
				}
			})
			.catch(err => alert(err.message));
	}

	//
	async function cargarEntidad(id) {

		GetEntidad(id)
			.then(entidad => {

				if (entidad !== undefined && entidad != null) {

					let nombreEntidad = document.getElementById('nombreEntidad');
					nombreEntidad.innerText = 'En ' + entidad.nombre;
					nombreEntidad.addEventListener('click', () => {
						window.location.href = 'landing-entidad.html?id=' + id;
					});

				}
			})
			.catch(error => {
				console.error('Error en GetEntidad:', error);
				alert('Error en GetEntidad: ', error);
			});
	}

	//
	async function cargarTipoEntidad(idTipoActividad) {

		const baseUrl = `https://localhost`;
		const controllerName = `TipoActividades`;
		const port = `44311`;
		const apiUrl = `${baseUrl}:${port}/${controllerName}/FiltrarTipoActividades`;

		const url = `${apiUrl}?filters.Id=${idTipoActividad}&filters.Activo=true`;

		fetch(url, { method: "GET" })
			.then(response => {
				if (!response.ok) throw new Error("Error en GetTipoActividades");
				return response.json();
			})
			.then(data => {

				if (data != undefined && data.length > 0 && data != null && data[0] != null) {
					document.getElementById('tipoActividad').innerText = 'Disfruta de la mejor ' + data[0].nombre + '!';
				}
			})
			.catch(err => alert(err.message));
	}

	//
	function formatearTimestamp(ts) {
		// Soporta:
		// "2025-10-03 16:34:40.730896"
		// "2025-12-15T18:00:00.730896"
		// "2025-12-15T18:00:00"
		if (!ts) return '';

		// Si nos pasan un Date, lo formateamos directamente
		if (ts instanceof Date) {
			const d = ts;
			const dia = d.getDate();
			const mes = d.getMonth() + 1;
			const anyo = d.getFullYear();
			const hh = String(d.getHours()).padStart(2, '0');
			const mm = String(d.getMinutes()).padStart(2, '0');
			const ss = String(d.getSeconds()).padStart(2, '0');
			return `el ${dia}/${mes}/${anyo} a las ${hh}:${mm}:${ss}h`;
		}

		// Normalizar: reemplazar 'T' por espacio para un único separador
		const normalized = ts.replace('T', ' ');

		// Separar fecha y hora
		const parts = normalized.split(' ');
		const fechaStr = parts[0] || '';
		let horaStr = parts[1] || '';

		// Si no hay hora, devolvemos solo la fecha formateada
		if (!horaStr) {
			const [yyyy, mm, dd] = fechaStr.split('-');
			return `el ${parseInt(dd)}/${parseInt(mm)}/${yyyy} a las 00:00:00`;
		}

		// Quitar fracciones de segundo si existen
		horaStr = horaStr.split('.')[0];

		// Descomponer fecha
		const fechaParts = fechaStr.split('-');
		const yyyy = fechaParts[0] ?? '';
		const mm = fechaParts[1] ?? '';
		const dd = fechaParts[2] ?? '';

		// Devolver en el formato requerido
		return `el ${parseInt(dd)}/${parseInt(mm)}/${yyyy} a las ${horaStr}h`;
	}

	//
	async function cancelarReserva(idUsuario, idActividad) {

		const params = new URLSearchParams({
			idUsuario: idUsuario,
			idActividad: idActividad
		});

		const baseUrl = `https://localhost`;
		const port = `44311`;

		const url = `${baseUrl}:${port}/ActividadReservas/CancelarReserva?${params.toString()}`;

		const response = await fetch(url, {
			method: "PUT"
		});

		if (!response.ok) {
			throw new Error(`Error ${response.status}`);
		}

		const result = await response.json(); // bool

		if (result === true) {
			window.location.reload();
		} else {
			alert("No se pudo cancelar la reserva");
		}
	}

	//
	// ReservarActividad
	//
	async function reservarActividad() {

		//reserva = false;
		var urlQuery = new URL(window.location.href);
		var urlParams = new URLSearchParams(urlQuery.search);
		var idActividad = urlParams.get('id');

		let idUsuario = localStorage.getItem('idUsuario');

		const baseUrl = `https://localhost`;
		const port = `44311`;
		const controllerName = `ActividadReservas`;
		const apiUrl = `${baseUrl}:${port}/${controllerName}/ReservarActividad`;

		const url = `${apiUrl}?idActividad=${idActividad}&idUsuario=${idUsuario}`;

		await fetch(url, { method: "POST" })
			.then(response => {
				if (!response.ok) throw new Error("Error en ReservarActividad");
				return response.json();
			})
			.then(data => {

				if (data != undefined && data != null) {

					mostrarModalReserva('Reserva Completada', `La reserva se ha realizado correctamente con el código de reserva [${data.codigoReserva}. Te hemos enviado un correo con toda la información.`, 'info');
					window.location.reload();

					//alert("IdReserva: " + data.idReserva);
					//alert("EstadoReserva: " + data.estadoReserva);
					//alert("fechaReserva: " + data.fechaReserva);
					//alert("FechaActividad: " + data.fechaActividad);
					//alert("IdUsuario: " + data.idUsuario);
					//alert("IdActividad: " + data.idActividad);
				}
			})
			.catch(err => alert(err.message));
	}

	function mostrarModalReserva(titulo, mensaje, mode) {
		const modal = document.getElementById("modalPanel-ConfirmarReserva");
		modal.setContent(titulo, mensaje, mode);
		modal.mostrar();
	}

	// click en reservar
	document.getElementById('btnReservarActividad').addEventListener('click', (e) => {
		mostrarModalReserva('Confirmar Reserva', '¿Deseas confirmar la reserva para esta actividad?', 'confirm');
	});

	// evento confirmar reserva
	document.getElementById("modalPanel-ConfirmarReserva").addEventListener('confirm', async (e) => {
		await reservarActividad()
	});

	//
	// CANCELAR RESERVA
	//
	function mostrarModalCancelar(titulo, mensaje, mode) {
		const modal = document.getElementById("modalPanel-CancelarReserva");
		modal.setContent(titulo, mensaje, mode);
		modal.mostrar();
	}

	// click en cancelar
	document.getElementById('btnCancelarReserva').addEventListener('click', (e) => {
		mostrarModalCancelar('Cancelar Reserva', '¿Deseas cancelar la reserva para esta actividad?', 'confirm');
	});

	// evento cancelar reserva async () => {
	document.getElementById("modalPanel-CancelarReserva").addEventListener('confirm', async (e) => {

		const idUsuario = localStorage.getItem("idUsuario");
		const idActividad = new URLSearchParams(window.location.search).get("id");

		await cancelarReserva(idUsuario, idActividad);
	});

	</script>

	<footer id="footer" class="footer"></footer>
	<script>
		(async () => {
			await renderFooter('footer');
		})()
	</script>

	<script src="./js/jquery.min.js"></script>
	<script src="./js/jquery-migrate-3.0.0.js"></script>
	<script src="./js/jquery-ui.min.js"></script>
	<script src="./js/easing.js"></script>
	<script src="./js/colors.js"></script>
	<script src="./js/popper.min.js"></script>
	<script src="./js/bootstrap-datepicker.js"></script>
	<script src="./js/jquery.nav.js"></script>
	<script src="./js/slicknav.min.js"></script>
	<script src="./js/jquery.scrollUp.min.js"></script>
	<script src="./js/niceselect.js"></script>
	<script src="./js/tilt.jquery.min.js"></script>
	<script src="./js/owl-carousel.js"></script>
	<script src="./js/jquery.counterup.min.js"></script>
	<script src="./js/steller.js"></script>
	<script src="./js/wow.min.js"></script>
	<script src="./js/jquery.magnific-popup.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<script src="./js/main.js"></script>
</body>
</html>