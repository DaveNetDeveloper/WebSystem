<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title> Charts / Actividad de Usuarios </title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="manifest" href="site.webmanifest">
		<link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <!--<link rel="stylesheet" href="css/owl.carousel.min.css">-->
        <link rel="stylesheet" href="css/animate.min.css">
        <!--<link rel="stylesheet" href="css/magnific-popup.css">-->
        <!--<link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/et-line-fonts.css">-->
        <!--<link rel="stylesheet" href="css/meanmenu.css">-->
        <link rel="stylesheet" href="css/chart.css">
        <link rel="stylesheet" href="css/default.css">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/responsive.css">
    </head>
    <body>
        <div class="body-wrapper body-bg">

            <header>
            </header>

            <div class="dashboard-area pt-30">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="pannel-wrapper white-bg mb-30">
                                <div class="panel-heading heading-border">
                                    <h4>Charts / Actividad de Usuarios</h4>
                                </div>
                                <div class="panel-body mt-30 pt-0">
                                    <div class="chart-js-warpper">
                                        <div class="flot-js-warpper">
                                            <div id="flot-categories" style="height: 250px"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



        </div>

        <script>

            document.addEventListener("DOMContentLoaded", async () => {

            var gridColor = "#aaaaaa";
            var gridBorder = "#eeeeee";
            var legendBg = "#f5f5f5";

            if ($("#flot-categories").length) {

                const baseUrl = `https://localhost`;
                const controllerName = `DataQuery`;
                const port = `44311`;
                const apiUrl = `${baseUrl}:${port}/${controllerName}/ObtenerVisitasTipoDispositivo`; 

                fetch(apiUrl)
                    .then(r => r.json())
                    .then(data => {
                        // Convertimos la fecha a "YYYY-Wxx"
                        function formatWeek(dateStr) {
                            let d = new Date(dateStr);
                            // Calcular la semana ISO
                            let dayNum = d.getUTCDay() || 7;
                            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                            let yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                            let weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                            return d.getUTCFullYear() + "-W" + weekNo;
                        }

                        // Transformar datos
                        data.forEach(d => {
                            d.semana = formatWeek(d.semana);
                        });

                        // Dispositivos únicos
                        let dispositivos = [...new Set(data.map(d => d.tipoDispositivo))];

                        // Construir series para Flot
                        let series = dispositivos.map(disp => {
                            return {
                                label: disp,
                                data: data
                                    .filter(x => x.tipoDispositivo === disp)
                                    .map(x => [x.semana, x.visitas])
                            };
                        });

                        // Pintar gráfico
                        $.plot($("#flot-categories"), series, {
                            series: {
                                shadowSize: 0,
                                lines: { show: true, fill: 0.1, lineWidth: 1 }
                            },
                            grid: {
                                color: gridColor,
                                borderColor: gridBorder,
                                borderWidth: 1,
                                hoverable: true,
                                clickable: true
                            },
                            xaxis: { mode: "categories", tickColor: gridBorder },
                            yaxis: { tickColor: gridBorder },
                            legend: { backgroundColor: legendBg },
                            tooltip: { show: true, content: "%s: %y" },
                            colors: ["#E040FB", "#E91E63", "#00BCD4"]
                        });
                    });
            }
             
            });
 
        </script>

        <!-- JS here -->
        <script src="js/vendor/modernizr-3.5.0.min.js"></script>
        <script src="js/vendor/jquery-1.12.4.min.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/Chart.bundle.js"></script>
        <script src="js/flot.js"></script>
        <!--<script src="js/plugins.js"></script>-->
        <!--<script src="js/main.js"></script>-->
        <!--<script src="js/flot-chart.js"></script>-->
    </body>
</html>
