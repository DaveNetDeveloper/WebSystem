<!doctype html>
<html class="no-js" lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>  Administración / Códigos QR</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--<link rel="manifest" href="site.webmanifest">-->
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

    <!-- <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="../css/et-line-fonts.css">
    <link rel="stylesheet" href="../css/themify-icons.css">-->
    <!--<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">-->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/owl.carousel.min.css">
    <link rel="stylesheet" href="../css/animate.min.css">
    <link rel="stylesheet" href="../css/magnific-popup.css">
    <link rel="stylesheet" href="../css/fontawesome-all.min.css">
    <link rel="stylesheet" href="../css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="../css/et-line-fonts.css">
    <link rel="stylesheet" href="../css/nice-select.css">
    <link rel="stylesheet" href="../css/typeaheadjs.css">
    <link rel="stylesheet" href="../css/themify-icons.css">
    <link rel="stylesheet" href="../css/meanmenu.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="../css/chart.css">
    <link rel="stylesheet" href="../css/default.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
</head>
<body>

    <div class="body-wrapper body-bg">
        <header>
            <admin-menu is-home="false"></admin-menu>
            <script type="module" src="../Components/adminHeader/adminHeader.js"></script>
        </header>
        <script>
            window.GlobalCssCache = {};
            async function preloadCss(path) {
                if (!window.GlobalCssCache[path]) {
                    const css = await fetch(path).then(r => r.text());
                    window.GlobalCssCache[path] = css;
                }
                return window.GlobalCssCache[path];
            }
        </script>
        <div class="dashboard-area pt-30">
            <div class="container">
                <div class="row">

                    <div class="col-lg-12">
                        <div class="pannel-wrapper white-bg mb-30">
                            <div class="panel-heading heading-border">
                                <h4>Crear un Código QR</h4>
                            </div>
                            <div class="panel-body">

                                <div class="custom-form">
                                    <form>
                                        <!--<div style="text-align: end;" class="form-group row">
                                        <div class="col-sm-8">
                                        </div>
                                        <div class="col-sm-4 ">
                                            <button style="width: 150px;" id="btnEliminar" class="btn btn-danger">ELIMINAR</button>
                                        </div>
                                    </div>-->
                                        <br /> <br />
                                        <div class="form-group row">
                                            <label style="cursor: default;" for="inputId" class="col-sm-2 col-form-label">Id</label>
                                            <div class="col-sm-10">
                                                <input style="background-color: #f7f7f7 !important; " disabled type="text" class="form-control" id="inputId" placeholder="">
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label style="cursor: default;" for="inputToken" class="col-sm-2 col-form-label">Token</label>
                                            <div class="col-sm-10">
                                                <input disabled style="background-color: #f7f7f7 !important; " type="text" class="form-control" id="inputToken" placeholder="">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label style="cursor: default;" for="payload" class="col-sm-2 col-form-label">Payload</label>
                                            <div class="col-sm-10">
                                                <textarea style="min-height:100px" class="form-control" id="payload"></textarea>
                                            </div>
                                        </div>

                                        <div class="input-append date form_datetime form-group row">
                                            <label style="cursor: default;" for="FechaExpiración" class="col-sm-2 col-form-label">Fecha de Expiración</label>
                                            <div class="col-sm-10">
                                                <input class="form-control" id="FechaExpiración" type="text" value="" placeholder="" readonly>
                                                <span style="margin-right: 15px;" class="add-on">
                                                    <i class="fas fa-th icon-th"></i>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label style="cursor: default;" for="listaEstados" class="col-sm-2 col-form-label">Estado</label>
                                            <div class="col-sm-10">
                                                <select style="cursor: pointer;" class="form-control" id="listaEstados">
                                                    <option value=""></option>
                                                    <option value="0">Inactive</option>
                                                    <option value="1">Active</option>
                                                    <option value="2">Consumed</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label style="cursor: default;" for="listaEntidades" class="col-sm-2 col-form-label">Entidad</label>
                                            <div class="col-sm-10">
                                                <select style="cursor: pointer;" class="form-control" id="listaEntidades">
                                                </select>
                                            </div>
                                        </div>

                                        <div id="divOrigenGroup" class="form-group row">
                                            <label style="cursor: default;" for="listaOrigenes" class="col-sm-2 col-form-label">Origen</label>
                                            <div class="col-sm-10">
                                                <select style="cursor: not-allowed;" class="form-control" id="listaOrigenes" disabled>
                                                    <option value=""></option>
                                                    <option value="producto">Producto</option>
                                                    <option value="actividad">Actividad</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div id="divProductosGroup" class="form-group row d-none">
                                            <label style="cursor: default;" for="listaProductos" class="col-sm-2 col-form-label">Producto</label>
                                            <div class="col-sm-10">
                                                <select style="cursor: pointer;" disabled class="form-control" id="listaProductos">
                                                </select>
                                            </div>
                                        </div>

                                        <div id="divActividadesGroup" class="form-group row d-none">
                                            <label style="cursor: default;" for="listaActividades" class="col-sm-2 col-form-label">Actividad</label>
                                            <div class="col-sm-10">
                                                <select style="cursor: pointer;" disabled class="form-control" id="listaActividades">
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label style="cursor: default;" for="imagenQRCode" class="col-sm-2 col-form-label">Imagen QR</label>
                                            <div class="col-sm-10">
                                                <img style="cursor: pointer; width: inherit; max-width: 250px;" src="" id="imagenQRCode" />
                                                <!--<button id="btnDescargarQR" class="btn btn-green mt-2">Descargar QR</button>-->
                                            </div>
                                        </div>


                                        <div class="form-group row">
                                            <label for="expiredCheck" style="cursor: default;" class="col-sm-2 col-form-label">Expirado?</label>
                                            <div class="col-sm-10">
                                                <div class="form-check">
                                                    <input style="cursor: default; width: 20px; height: 20px;" class="form-check-input" type="checkbox" id="expiredCheck">
                                                </div>
                                            </div>
                                        </div>

                                        <br /> <br />

                                        <div style="margin-top: 50px;" class="form-group row">
                                            <div class="col-sm-8" style="width: auto;">
                                                <button style="width: 150px;" id="btnCancelar" class="btn btn-dark">CANCELAR</button>

                                            </div>
                                            <div style="width: auto; text-align: right;" class="col-sm-4">
                                                <button style="width: 150px;" id="btnGuardar" type="submit" class="btn btn-primary">CREAR</button>
                                            </div>
                                        </div>

                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <footer>
            </footer>
        </div>
    </div>


    <script type="text/javascript">
        (() => {

            /* Configuración y Constantes */
            const TIPO_ENTIDAD = {
                COMERCIO: "64569dd3-4d65-4eed-9f41-ea87b2270a6c",
                ASOCIACION: "e170a0db-660f-4c34-ae71-3e9b9dbbd92b"
            };
            const API = {
                // CAMBIO: Nuevo Endpoint de creación Full
                QR_CREATE: "https://localhost:44311/api/qr/CrearQRFull",
                ENTIDADES: "https://localhost:44311/Entidades/ObtenerEntidades",
                PRODUCTOS: "https://localhost:44311/Productos/FiltrarProductos",
                ACTIVIDADES: "https://localhost:44311/Actividades/FiltrarActividades"
            };
            const LISTADO_URL = "../admin/qrs-list.html";
            let todasLasEntidades = [];

            /*  DOM y Utils */
            const inputId = document.getElementById("inputId");
            const inputToken = document.getElementById("inputToken");
            const payloadInput = document.getElementById("payload");
            const fechaExpInput = document.getElementById("FechaExpiración");
            const listaEstados = document.getElementById("listaEstados");
            const listaEntidades = document.getElementById("listaEntidades");
            const listaOrigenes = document.getElementById("listaOrigenes");
            const listaProductos = document.getElementById("listaProductos");
            const listaActividades = document.getElementById("listaActividades");
            const divProductosGroup = document.getElementById("divProductosGroup");
            const divActividadesGroup = document.getElementById("divActividadesGroup");
            const imagenQRCode = document.getElementById("imagenQRCode");
            const expiredCheck = document.getElementById("expiredCheck");
            const btnGuardar = document.getElementById("btnGuardar");
            const btnCancelar = document.getElementById("btnCancelar");

            const volverAlListado = () => window.location.href = LISTADO_URL;
            const limpiarSelect = (select, placeholder = "-- Selecciona --") => {
                select.innerHTML = `<option value="">${placeholder}</option>`;
            };
            const ocultar = element => element.classList.add('d-none');
            const mostrar = element => element.classList.remove('d-none');

            function limpiarFormulario() {
                imagenQRCode.src = "";
                expiredCheck.checked = false;
                actualizarVisibilidadOrigen();
            }

            /*Lógica de TTL (Time-To-Live) */
            function calcularTTL(fechaExpiracionInput) {
                if (!fechaExpiracionInput || String(fechaExpiracionInput).trim() === "") {
                    return null;
                }

                const fechaExpiracion = new Date(fechaExpiracionInput);
                const ahoraUTC = new Date();

                if (isNaN(fechaExpiracion.getTime())) {
                    return null;
                }

                let diferenciaMs = fechaExpiracion.getTime() - ahoraUTC.getTime();

                if (diferenciaMs <= 0) {
                    diferenciaMs = 1000;
                }

                const ttlSegundos = Math.ceil(diferenciaMs / 1000);

                return ttlSegundos;
            }

            /* Validación */
            function validarFormulario() {
                // Estos campos deben estar llenos para que la solicitud al backend tenga sentido
                const camposAValidar = [
                    // inputId.value,          // No se valida si es readonly y vacío al crear
                    // inputToken.value,       // No se valida si es readonly y vacío al crear
                    payloadInput.value,
                    listaEstados.value,
                    listaEntidades.value,
                    listaOrigenes.value
                    // Nota: La fecha de expiración (y TTL) es opcional para el backend,
                    // pero si se pide en el formulario, se añade. Aquí la dejamos opcional.
                    // fechaExpInput.value,
                ];

                const origen = listaOrigenes.value;
                // Si Origen está seleccionado, su campo asociado debe estar lleno
                if (origen === "producto") {
                    camposAValidar.push(listaProductos.value);
                } else if (origen === "actividad") {
                    camposAValidar.push(listaActividades.value);
                }

                const todosLlenos = camposAValidar.every(valor =>
                    valor !== null && valor !== undefined && String(valor).trim() !== ""
                );

                if (!todosLlenos) {
                    alert("Debes informar todos los campos requeridos.");
                    return false;
                }
                return true;
            }

            /*  Lógica de Carga y Eventos  */
            async function cargarEntidades() {
                const res = await fetch(API.ENTIDADES);
                todasLasEntidades = await res.json();

                limpiarSelect(listaEntidades, "-- Selecciona entidad --");

                todasLasEntidades
                    .filter(e => e.activo)
                    .forEach(e => {
                        const opt = document.createElement("option");
                        opt.value = e.id;
                        opt.textContent = e.nombre;
                        listaEntidades.appendChild(opt);
                    });
            }

            async function cargarProductos(idEntidad) {
                limpiarSelect(listaProductos, "-- Selecciona producto --");
                listaProductos.disabled = true;
                listaActividades.disabled = true;

                const res = await fetch(`${API.PRODUCTOS}?IdEntidad=${idEntidad}&Activo=true`);
                const productos = await res.json();

                productos.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.textContent = p.nombre;
                    listaProductos.appendChild(opt);
                });

                listaProductos.disabled = false;
            }

            async function cargarActividades(idEntidad) {
                limpiarSelect(listaActividades, "-- Selecciona actividad --");
                listaProductos.disabled = true;
                listaActividades.disabled = true;

                const res = await fetch(`${API.ACTIVIDADES}?IdEntidad=${idEntidad}&Activo=true`);
                const result = await res.json();

                result.items.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.id;
                    opt.textContent = a.nombre;
                    listaActividades.appendChild(opt);
                });

                listaActividades.disabled = false;
            }

            function actualizarVisibilidadOrigen() {
                const origen = listaOrigenes.value;
                ocultar(divProductosGroup);
                ocultar(divActividadesGroup);

                if (origen === "producto") {
                    mostrar(divProductosGroup);
                } else if (origen === "actividad") {
                    mostrar(divActividadesGroup);
                }
            }

            async function manejarEntidadSeleccionada(idEntidad) {
                limpiarSelect(listaProductos, "-- Selecciona producto --");
                limpiarSelect(listaActividades, "-- Selecciona actividad --");
                listaProductos.disabled = true;
                listaActividades.disabled = true;

                if (!idEntidad) {
                    listaOrigenes.value = "";
                    actualizarVisibilidadOrigen();
                    return;
                }

                const entidad = todasLasEntidades.find(e => e.id == idEntidad);
                if (!entidad) {
                    listaOrigenes.value = "";
                    actualizarVisibilidadOrigen();
                    return;
                }

                let nuevoOrigen = "";
                if (entidad.idTipoEntidad === TIPO_ENTIDAD.COMERCIO) {
                    nuevoOrigen = "producto";
                } else if (entidad.idTipoEntidad === TIPO_ENTIDAD.ASOCIACION) {
                    nuevoOrigen = "actividad";
                }
                listaOrigenes.value = nuevoOrigen;

                actualizarVisibilidadOrigen();

                if (nuevoOrigen === "producto") {
                    await cargarProductos(idEntidad);
                } else if (nuevoOrigen === "actividad") {
                    await cargarActividades(idEntidad);
                }
            }

            /*  Crear QR (Guardar con Payload Full) */
            async function crearQRCode(e) {
                e.preventDefault();

                if (!validarFormulario()) {
                    return;
                }

                // Cálculo de TTL y obtención de IDs
                const ttlCalculado = calcularTTL(fechaExpInput.value);
                const origenSeleccionado = listaOrigenes.value;

                // Aseguramos que los valores sean enteros o null, y no strings vacíos.
                const estadoNumerico = listaEstados.value ? parseInt(listaEstados.value, 10) : null;
                const idEntidadValor = listaEntidades.value ? parseInt(listaEntidades.value, 10) : null;

                const idProductoValor = origenSeleccionado === "producto" && listaProductos.value
                    ? parseInt(listaProductos.value, 10)
                    : null;
                const idActividadValor = origenSeleccionado === "actividad" && listaActividades.value
                    ? parseInt(listaActividades.value, 10)
                    : null;


                // CONSTRUCCIÓN DEL PAYLOAD (Mapeado a CreateQRCodeFullRequest)
                const qr = {
                    // Detalle Básico
                    payload: payloadInput.value,
                    ttl: ttlCalculado,
                    origen: origenSeleccionado,

                    // Asociación
                    idEntidad: idEntidadValor,
                    idProducto: idProductoValor,
                    idActividad: idActividadValor,

                    // Estado
                    status: estadoNumerico
                };

                // Si IdEntidad o Status no pueden ser null en C# (ya que son int en el record),
                // la validación debe asegurar que no son null. La validación actual lo hace.
                if (idEntidadValor === null || estadoNumerico === null) {
                    alert("Error de lógica: Entidad y Estado deben ser valores enteros válidos.");
                    return;
                }

                // Envío al nuevo Endpoint
                const res = await fetch(API.QR_CREATE, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(qr)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`Error al crear QR (HTTP ${res.status}): ${errorText.substring(0, 100)}...`);
                    return;
                }

                alert("QR creado correctamente.");
                window.location.href = "../admin/qrs-form.html?id=" + nuevoQR.id;
            }

            function generarGUID() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                // Fallback simple si el entorno no soporta crypto.randomUUID (muy raro hoy día)
                // Aunque no cumple el estándar UUID v4 estrictamente, sirve como un ID único
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function asignarIdsIniciales() {
                // Aseguramos que solo se asignen si están vacíos (o si se fuerza la creación)
                if (!inputId.value) {
                    inputId.value = generarGUID();
                }
                if (!inputToken.value) {
                    inputToken.value = generarGUID();
                }
            }

            /*  Inicialización y Event Listeners */
            listaEntidades.addEventListener("change", (e) => manejarEntidadSeleccionada(e.target.value));
            btnGuardar.addEventListener("click", crearQRCode);
            btnCancelar.addEventListener("click", e => {
                e.preventDefault();
                volverAlListado();
            });

            (async () => {
                try {
                    limpiarFormulario();

                    asignarIdsIniciales();

                    await cargarEntidades();
                } catch (err) {
                    console.error("Error durante la inicialización:", err);
                    alert("Error al cargar datos iniciales: " + err.message);
                }
            })();

        })();
    </script>

    <script>
        document.getElementById('expiredCheck').addEventListener('click', function (event) {
            event.preventDefault();
        });
    </script>

    <script src="../js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="../js/vendor/jquery-1.12.4.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/jquery.meanmenu.min.js"></script>
    <script src="../js/bootstrap-datetimepicker.min.js"></script>
    <script src="../js/typeahead.min.js"></script>
    <script src="../js/jquery.nice-select.min.js"></script>
    <script src="../js/plugins.js"></script>
    <!-- active code -->
    <script src="../js/datetimepicker-active.js"></script>
    <script src="../js/typeahead-active.js"></script>
    <script src="../js/nice-select-active.js"></script>
    <script src="../js/main.js"></script>

</body>
</html>